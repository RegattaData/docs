---
title: "PreFlight Tool"
description: "Environment performance, info and readiness checks"
---

**PreFlight** is a system utility tool developed by **Regatta** to assist with system diagnostics, benchmarking, and network analysis. It integrates a variety of open-source components to provide a comprehensive suite of tools for system administrators and developers.

---

## Features

- System performance benchmarking
- Network throughput and latency testing
- Disk I/O stress testing
- System information and diagnostics
- Lightweight with minimal dependecies

## What Gets Checked

#### Operating System & Kernel

- OS name and version detection
- Kernel version and architecture
- System uptime and boot information

#### CPU Analysis

- Physical cores and logical threads
- CPU model and frequency information
- NUMA configuration
- Performance benchmarking (sysbench)

#### Memory Analysis

- Total, available, and used memory
- Swap usage and configuration
- Memory throughput benchmarking

#### Storage & Filesystem

- Disk type detection (SSD/HDD/NVMe)
- Filesystem information and mount options
- Disk usage and available space
- I/O performance testing (FIO)

#### Network Configuration

- Network interface enumeration
- IP address configuration
- DNS resolution testing
- Interconnectivity validation
- Throughput testing (iperf3)

#### Security Analysis

- **SELinux**: Status, mode, policy, boolean settings
- **AppArmor**: Profile statistics and enforcement status
- **Firewall**: UFW, firewalld, or iptables analysis
- **SSH Configuration**: Port, authentication methods, security settings
- **Security Services**: Status of critical security services

#### System Configuration

- ulimit values (open files, stack size)
- Important sysctl parameters
- Process limits and system constraints

### Kernel & Journal Log Capture

- Copies `dmesg` and `journalctl` logs from hosts when present for troubleshooting
- Hardware-related message extraction and categorization are available within host scripts

---

## Installation & Dependencies

### Dependency Management

There are 2 sets of dependecies needed:

1. **Orchestrator (preFlight.sh) Dependencies** - Installed on the machine running the orchestrator
2. **Remote Host Dependencies** - Installed on **target hosts**
   - Can be auto installed by the Orchestrator via `--auto-install-deps` flag)
   - If not using the auto-install, all host dependencies should be pre installed on all hosts before running.

### Orchestrator (preFlight.sh) Dependencies

These must be installed manually on the machine running the orchestrator:

- **jq** - JSON processing for parsing results
- **bc** - Mathematical calculations (compression ratios, analysis)
- **tar/gzip** - Archive creation (for --compress option)
- **ssh/scp** - Remote host communication
- **coreutils** - Basic utilities (find, grep, awk, sed, etc.)

### Remote Host Dependencies

These can be automatically installed on remote hosts if using `--auto-install-deps`, given the hosts have access to the internet.

- **curl**
- **bc**
- **tar**
- **findutils**
- **net-tools**
- **bind-utils**
- **iperf3** - benchmark network throughput.
- **fio** - benchmark the disk
- **sysbench** - benchmark cpu & memory

---

## SSH

SSH key is required by the preFlight for connecting to the host nodes.\
In case of a single-node deployment in which the preFlight runs on the same node used as a target host, you can create an SSH key-pair using the following command:

```
ssh-keygen -t ed25519 -f ~/.ssh/id_rdt -N "" && cat ~/.ssh/id_rdt.pub >> ~/.ssh/authorized_keys
```

---

## Quick Start (preFlight.sh)

```bash
# 1) Generate inventory with devices (replace user and hosts)
./util/detect_devices.sh -u <user_name> 192.168.1.10 192.168.1.11 > hosts.json

# 2) Run orchestrator (requires SSH to all hosts)
./preFlight.sh -i hosts.json -r /tmp/cluster_ready -k <path_to_ssh_key> -u <user_name> 

# 3) Inspect results
ls -1 cluster_results_*/
```

## All Options (Parameters) for the `preFlight.sh`

### Configuration Parameters

| Parameter             | Description                                                                                                                                                                                                                     |
| --------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -h, --help            | Show help message                                                                                                                                                                                                               |
| -i, --inventory       | Inventory file with host list (text format) or JSON format with hosts and devices<br />**Note** The foramt of this file is explained later.<br />**Note **that the file can be generated via the `util/detect_devices.sh` tool. |
| -k, --ssh-key         | SSH private key file                                                                                                                                                                                                            |
| -u, --user            | SSH user (default: root)                                                                                                                                                                                                        |
| -o, --output-dir      | Output directory (default: cluster_results_TIMESTAMP)                                                                                                                                                                           |
| -r, --remote-work-dir | Remote work directory on target hosts (required)                                                                                                                                                                                |
| --timeout SECONDS     | SSH timeout (default: 300)                                                                                                                                                                                                      |
| -v, --verbose         | Enable verbose output                                                                                                                                                                                                           |
| --vpc                 | Use internal IPs for interconnectivity.<br />Used for hosts in VPC and external orchestrator.                                                                                                                                   |
| --auto-install-deps   | Automatically install missing dependencies on hosts                                                                                                                                                                             |
| --keep-host-files     | Keep scripts and results on remote hosts (default: cleanup)                                                                                                                                                                     |
| --keep-host-deps      | Keep dependencies installed on hosts after completion                                                                                                                                                                           |
| --compress            | Create compressed archive of results directory after completion                                                                                                                                                                 |

### Test Parameters

| --interconnectivity               | Test interconnectivity between nodes                                                                                                                                                                                                                                                                                                                               |
| --------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| --network-throughput              | Test network throughput using iperf3                                                                                                                                                                                                                                                                                                                               |
| --throughput-server-host          | Choose the host to be server in server-to-all throughput iperf3 test<br />Default: First in inventory file                                                                                                                                                                                                                                                         |
| --throughput-all-hosts-as-servers | Test network throughput using iperf3 (all-to-all)<br /><br />**Note**: This option is mutually exclusive with --throughput-server-host<br />Default: false                                                                                                                                                                                                         |
| --cpu-benchmark                   | Run CPU performance benchmarks                                                                                                                                                                                                                                                                                                                                     |
| --memory-benchmark                | Run memory performance benchmarks                                                                                                                                                                                                                                                                                                                                  |
| --gather-static-info              | Gather static system information                                                                                                                                                                                                                                                                                                                                   |
| --rdb-ready-checks                | Run RDB process-ready checks:<br /><br />- Detects if `rdb.bin` is already running (and skips further checks on those hosts)<br />- Checks port availability 8840–8900<br />- Verifies required file structure (e.g., `/usr/lib64/libssl.so` symlink)<br />- Confirms required services (systemd state)<br />- Notes NUMA domains for potential performance impact |
| --parallel-fio                    | Run FIO tests in parallel across all nodes                                                                                                                                                                                                                                                                                                                         |
| --sequential-fio                  | Run FIO tests sequentially on each node                                                                                                                                                                                                                                                                                                                            |
| --use-default-fio                 | Use default FIO files from fio_testing directory<br />**Note**: If neither option is specified, default behavior uses fio_testing directory<br />**Note**: This option is mutually exclusive with --fio-files                                                                                                                                                      |
| --fio-files "file1,file2"         | fio files to be used for testing (comma-separated paths)                                                                                                                                                                                                                                                                                                           |
| --fio-fill-device                 | Include fill_device.fio in testing (optional, for device preparation)<br />This will override some of the disk space so that later tests run on a non-empty disk.                                                                                                                                                                                                  |
| -p, --preset                      | Use preset configuration (basic, performance, comprehensive, fast, debug) to specify multipule flags together. Read the help page to choose a relvant preset.                                                                                                                                                                                                      |

### Examples:

```bash
# Simple connectivity test
./preFlight.sh -i hosts.json -k ~/.ssh/cluster_key -r /tmp/test

# Using multipule options
./preFlight.sh -i hosts.json -k ~/.ssh/cluster_key -r /tmp/test --auto-install-deps --interconnectivity --parallel-fio --sequential-fio --network-throughput
```

### Inventory File Format

JSON Format (with target devices to test specified)\
This is the users' way of informing the preFlight tool of who are the target hosts, and for each, which storage devices should be inspected. 

Example: (note the file can be generated via the `util/detect_devices.sh` tool)

```json
{
  "hosts": {
    "192.168.1.10": {
      "devices": [
        {"path": "/dev/sda", "type": "hdd", "size_bytes": 1000000000000},
        {"path": "/dev/nvme0n1", "type": "nvme", "size_bytes": 500000000000}
      ]
    },
    "192.168.1.11": {
      "devices": [
        {"path": "/dev/sdb", "type": "ssd", "size_bytes": 2000000000000}
      ]
    }
  }
}
```

### FIO Files

If you wish to use custom fio tests, you can use the `--fio-files` parameter.\
The files must conform to fio input structure. Example below:

```
# here are shared properties for all following tests in the file
[global]
filename=/dev/nvme0n2 # will be overriten during preFlight run
kb_base=1024
ioengine=libaio
direct=1
# runtime of each job in seconds. Can be overriden in the section of the job.
runtime=5
stonewall
group_reporting

# this is the first test of the file
[rand_read_4k_1]
readwrite=randread
blocksize=4k
numjobs=1
iodepth=1

# ... more tests here
```

## Output & Results

### File Structure

All results are saved with timestamps:

```
├── orchestrator.log                       # Main execution log
├── cluster_summary.json                   # Aggregated report (per-host + references)
├── file_listing.json                      # Flat listing of files in results dir
├── fio_config_analysis_results.json       # FIO configuration analysis (write/safety)
├── interconnectivity_matrix.json          # Host-to-host connectivity (ping/ssh/port)
├── interconnectivity_logs/                # Detailed per-connection logs
├── network_throughput_matrix.json         # iperf3 results (matrix)
├── network_throughput_summary.json        # Stats (min/max/avg, success rate)
├── rdb_process_ready_results.json         # RDB ready checks (if enabled)
├── fio_files/                             # FIO job files used for tests (if any)
├── <host_ip_1>/                           # Per-host data (one directory per host)
│   ├── logs/                              # Per-host logs (readiness, dependencies, FIO, etc.)
│   ├── results/                           # Per-host JSON results
│   │   ├── static_gather.json             # Static system info (system_readiness subset)
│   │   ├── cpu_benchmark.json             # CPU benchmark results
│   │   ├── memory_benchmark.json          # Memory benchmark results
│   │   ├── device_check.json              # Device verification results from inventory
│   │   └── fio/
│   │       ├── merged_parallel_fio.json   # Consolidated parallel FIO results for this host
│   │       └── merged_sequential_fio.json # Consolidated sequential FIO results for this host
│   ├── dmesg_*.log                        # Per-host kernel logs copied back when present
│   └── journalctl_*.log[.gz]              # Per-host journal logs copied back when present
└── <host_ip_2>/                           # Same structure per host
    └── ...
```

## Troubleshooting

### Common Issues

#### SSH Connectivity Issues

```bash
# Test SSH connectivity manually
ssh -i ~/.ssh/key user@192.168.1.10

# Check SSH service on target
ssh user@192.168.1.10 "systemctl status sshd"
```

#### Permission Issues

```bash
# Run with sudo if needed
sudo ./host_files/system_readiness_check.sh

# Check SSH user permissions
ssh user@192.168.1.10 "sudo -l"
```

---

# Advanced

## **Execution Flow**

The system uses a manager-hosts flow: an orchestrator will commence tests on target hosts listed in the inventory file, gather results and finally overlook the cleanup.

We can split the files into groups - needed by the orchestrator or needed by the hosts (common.sh is shared):

#### Orchestrator Machine

- **Script**: `preFlight.sh`
- **Purpose**: Coordinates, manages, and analyzes results from remote hosts
- **Libraries**: All `/lib/*.sh` files for orchestration logic
- **Dependencies**: Lightweight - mainly SSH tools, JSON processing, and basic utilities

#### Remote Hosts (Target Machines)

- **Scripts**: Files in `/host_files/` directory
  - `system_readiness_check.sh` - Main remote diagnostic script
  - `fio_benchmark_only.sh` - FIO testing script
  - `remote_fio_wrapper.sh` - FIO wrapper for remote execution
  - `install_dependencies.sh` - Dependency installation script
- **Purpose**: Execute actual system tests and diagnostics
- **Libraries**: Only `lib/common.sh` (copied to remote hosts)
- **Dependencies**: Comprehensive - performance testing tools, system analysis utilities

## Responsibilities of Different Scripts

### System Readiness Check (`host_files/system_readiness_check.sh`)

- Intended to run under the orchestrator. It expects parameters and supporting files prepared by the orchestrator.
- Performs system diagnostics, CPU/memory benchmarks, and disk tests when invoked remotely by the orchestrator.
- Outputs structured JSON used by the orchestrator for aggregation.

### Cluster Orchestrator (`preFlight.sh`)

- **Multi-machine coordination** - Test entire clusters at once
- **Interconnectivity testing** - Verify all nodes can communicate
- **Parallel FIO testing** - Performance testing across all nodes simultaneously
- **Sequential FIO testing** - Individual node performance analysis
- **Network throughput** - iperf3 testing between nodes (all-to-all or one-to-many)
- **Dependency management** - Auto-install missing packages via `--auto-install-deps`

### FIO Benchmark Tool (`host_files/fio_benchmark_only.sh`)

- **Disk performance testing** - Comprehensive I/O benchmarks
- **Multiple test modes** - Basic (4 tests) or extensive (141 tests)
- **Device detection** - Automatic discovery of storage devices
- **Individual test control** - Run specific test configurations

---

## License

PreFlight is licensed under the **GNU General Public License v2.0 (GPL-2.0)**.

See the [LICENSE](./LICENSE) file for full details.